{% extends "crm/base.html" %}
{% block title %}Главная{% endblock %}
{% block content %}
  <h1>Добро пожаловать!</h1>
  {% if role == "admin" %}
    <p>Вы вошли как администратор. Управляйте курсами, абонементами и связями родителей.</p>
    <p>
      <a class="btn" href="{% url 'crm:course_create' %}">Создать курс</a>
      <a class="btn" href="{% url 'crm:student_create' %}">Добавить ученика</a>
      <a class="btn" href="{% url 'crm:subscription_create' %}">Добавить абонемент</a>
      <a class="btn" href="{% url 'crm:student_guardian_link' %}">Привязать родителя</a>
      <a class="btn" href="{% url 'crm:assign_role' %}">Назначить роль</a>
    </p>
    <h2>Курсы</h2>
    <div class="table-filter">
      <label for="courses-search">Поиск курса</label>
      <input id="courses-search" type="search" placeholder="Введите название" data-filter-target="#courses-table" />
    </div>
    <table class="sheet-table" id="courses-table">

      <thead>
        <tr>
          <th>Название</th>
          <th>Преподаватель</th>
          <th>Расписание</th>
        </tr>
      </thead>
      <tbody>
        {% for course in courses %}
          <tr data-filter-value="{{ course.title }}">
            <td><a href="{% url 'crm:course_detail' course.pk %}">{{ course.title }}</a></td>
            <td>{{ course.teacher|default:"Не назначен" }}</td>
            <td>{{ course.schedule|default:"—" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3">Пока нет курсов</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <h2>Ученики</h2>
    <div class="table-filter">
      <label for="students-search">Фильтр по ученикам</label>
      <input
        id="students-search"
        type="search"
        placeholder="Имя ученика, родителя или преподавателя"
        data-filter-target="#students-table"
      />
    </div>
    <table class="sheet-table" id="students-table">
      <thead>
        <tr>
          <th>Ученик</th>
          <th>Родители</th>
          <th>Преподаватели</th>
          <th>Куплено занятий</th>
          <th>Использовано</th>
          <th>Остаток</th>
          <th>Долг</th>
        </tr>
      </thead>
      <tbody>
        {% for student in students %}
          {% with balance=student.lessons_balance %}
            <tr
              data-filter-value="{{ student.full_name }} {{ student.guardian_display }} {{ student.teacher_display }}"
            >
              <td><a href="{% url 'crm:student_detail' student.pk %}">{{ student.full_name }}</a></td>
              <td>{{ student.guardian_display }}</td>
              <td>{{ student.teacher_display }}</td>
              <td>{{ balance.purchased }}</td>
              <td>{{ balance.used }}</td>
              <td>{{ balance.remaining }}</td>
              <td>{% if balance.debt %}<strong>{{ balance.debt }}</strong>{% else %}0{% endif %}</td>
            </tr>
          {% endwith %}
        {% empty %}
          <tr>
            <td colspan="6">Ученики ещё не добавлены.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div style="display: grid; gap: 2rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
      <section class="sheet-card">
        <h3>Последние абонементы</h3>
        <ul style="margin: 0; padding-left: 1.2rem; color: #3c4043;">
          {% for subscription in recent_subscriptions %}
            <li style="margin-bottom: 0.6rem;">
              <strong>{{ subscription.student.full_name }}</strong><br />
              {{ subscription.course.title }} — куплен {{ subscription.purchase_date|date:"d.m.Y" }}
            </li>
          {% empty %}
            <li>Пока нет абонементов</li>
          {% endfor %}
        </ul>
      </section>
      <section class="sheet-card">
        <h3>Ученики с долгами</h3>
        <ul style="margin: 0; padding-left: 1.2rem; color: #3c4043;">
          {% for item in students_with_debt %}
            <li style="margin-bottom: 0.6rem;">
              <strong>{{ item.student.full_name }}</strong><br />
              Долг: {{ item.balance.debt }} занятий
            </li>
          {% empty %}
            <li>Нет задолженностей по занятиям</li>
          {% endfor %}
        </ul>
      </section>
    </div>
  {% elif role == "teacher" %}
    <p>Вы вошли как преподаватель. Создавайте занятия и отмечайте посещаемость.</p>
    <p><a class="btn" href="{% url 'crm:lesson_create' %}">Создать занятие</a></p>
    {% for course in courses %}
      <section>
        <h2>{{ course.title }}</h2>
        {% with course.lessons.all|first as latest_lesson %}
          <p>
            Последнее занятие:
            {% if latest_lesson %}
              {{ latest_lesson.date|date:"d.m.Y" }}
            {% else %}
              нет занятий
            {% endif %}
          </p>
        {% endwith %}
        <p><a class="btn" href="{% url 'crm:course_detail' course.pk %}">Перейти к курсу</a></p>
        <h3>Недавние занятия</h3>
        <ul style="margin: 0; padding-left: 1.2rem; color: #3c4043;">
          {% for lesson in course.lessons.all|slice:":5" %}
            <li style="margin-bottom: 0.75rem;">
              <strong>{{ lesson.date|date:"d.m.Y" }}</strong> — {{ lesson.topic|default:"Без темы" }}<br />
              <a class="btn btn-secondary" href="{% url 'crm:lesson_manage' lesson.pk %}">Открыть таблицу</a>

            </li>
          {% empty %}
            <li>Пока нет занятий</li>
          {% endfor %}
        </ul>
      </section>
    {% empty %}
      <p>Вам не назначены курсы.</p>
    {% endfor %}
  {% elif role == "parent" %}
    <p>Вы вошли как родитель. Просматривайте посещаемость и абонементы ваших детей.</p>
    {% for student in students %}
      <section>
        <h2>
          <a href="{% url 'crm:student_detail' student.pk %}">{{ student.full_name }}</a>
        </h2>
        {% with balance=student.lessons_balance %}
          <p>
            Куплено занятий: {{ balance.purchased }}, использовано: {{ balance.used }}, остаток: {{ balance.remaining }},
            {% if balance.debt %}
              <strong>долг: {{ balance.debt }}</strong>
            {% else %}
              долг: 0
            {% endif %}
          </p>
        {% endwith %}
        <h3>Последние занятия</h3>
        <ul style="margin: 0; padding-left: 1.2rem; color: #3c4043;">
          {% for attendance in student.attendances.all|slice:":5" %}
            {% with progress=attendance.exercise_progress %}
              <li style="margin-bottom: 0.75rem;">
                <strong>{{ attendance.lesson.date|date:"d.m.Y" }}</strong> — {{ attendance.lesson.course.title }}<br />
                Посещение: {{ attendance.get_status_display }}<br />
                {% if progress.total %}
                  <span class="chip chip--solved">{{ progress.solved }}/{{ progress.total }} решено</span>
                  {% if progress.partial %}<span class="chip chip--partial">{{ progress.partial }} частично</span>{% endif %}
                  {% if progress.pending %}<span class="chip chip--pending">{{ progress.pending }} не решено</span>{% endif %}
                {% else %}
                  <span class="chip">Без упражнений</span>
                {% endif %}
              </li>
            {% endwith %}

          {% empty %}
            <li>Данных о посещаемости пока нет</li>
          {% endfor %}
        </ul>
        <h3>Абонементы</h3>
        <ul>
          {% for subscription in student.subscriptions.all %}
            <li>
              {{ subscription.course.title }} — {{ subscription.lessons_included }} занятий за {{ subscription.price }} ₽
              (дата покупки: {{ subscription.purchase_date|date:"d.m.Y" }})
            </li>
          {% empty %}
            <li>Абонементы ещё не добавлены</li>
          {% endfor %}
        </ul>
      </section>
    {% empty %}
      <p>К вашему аккаунту не привязаны ученики. Обратитесь к администратору.</p>
    {% endfor %}
  {% else %}
    <p>У вашего аккаунта пока нет роли. Пожалуйста, обратитесь к администратору.</p>
  {% endif %}
{% endblock %}
