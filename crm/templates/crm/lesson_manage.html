{% extends "crm/base.html" %}
{% load crm_extras %}
{% block title %}{{ course.title }} — {{ lesson.date|date:"d.m.Y" }}{% endblock %}
{% block content %}
  <h1>{{ course.title }} — {{ lesson.date|date:"d.m.Y" }}</h1>
  <p style="color: #5f6368; margin-bottom: 1.5rem;">
    Тема: <strong>{{ lesson.topic|default:"—" }}</strong>
  </p>

  <section style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end; margin-bottom: 2rem;">
    <div>
      <h2 style="margin-bottom: 0.5rem;">Упражнения занятия</h2>
      <p style="max-width: 480px; color: #5f6368;">
        Добавляйте упражнения, чтобы фиксировать решения по каждому ученику в табличной форме.
      </p>
    </div>
    <form method="post" style="flex: 1 1 320px; max-width: 420px;" class="sheet-card">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_exercise" />
      <label for="id_exercise-title">Название упражнения</label>
      {{ exercise_form.title }}
      <div style="display: grid; grid-template-columns: 1fr 120px; gap: 1rem;">
        <div>
          <label for="id_exercise-description">Описание</label>
          {{ exercise_form.description }}
        </div>
        <div>
          <label for="id_exercise-order">Порядок</label>
          {{ exercise_form.order }}
        </div>
      </div>
      <p style="margin-top: 1.25rem;">
        <button class="btn" type="submit">Добавить упражнение</button>
      </p>
    </form>
  </section>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="update" />
    <div class="sheet-scroll">
      <table class="sheet-table">
        <thead>
          <tr>
            <th style="min-width: 220px;">Ученик</th>
            <th style="min-width: 160px;">Посещение</th>
            <th style="min-width: 220px;">Комментарий</th>
            {% for exercise in exercises %}
              <th style="min-width: 180px;">
                {{ exercise.title }}
                {% if exercise.description %}
                  <div style="font-weight: 400; text-transform: none; letter-spacing: normal; font-size: 0.75rem; color: #5f6368;">
                    {{ exercise.description }}
                  </div>
                {% endif %}
              </th>
            {% empty %}
              <th style="min-width: 180px;">Упражнения ещё не добавлены</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for attendance in attendances %}
            <tr>
              <td>
                <strong>{{ attendance.student.full_name }}</strong>
              </td>
              <td>
                <select name="attendance-status-{{ attendance.student_id }}">
                  {% for value, label in attendance_statuses %}
                    <option value="{{ value }}" {% if attendance.status == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <input type="text" name="attendance-comment-{{ attendance.student_id }}" value="{{ attendance.comment }}" placeholder="Комментарий" />
              </td>
              {% for exercise in exercises %}
                {% with student_results=result_lookup|get_item:attendance.student_id %}
                  {% with result=student_results|get_item:exercise.id %}
                  <td>
                    <select name="exercise-{{ exercise.id }}-student-{{ attendance.student_id }}">
                      {% for value, label in exercise_statuses %}
                        <option value="{{ value }}" {% if result and result.status == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                    <input type="text" name="exercise-{{ exercise.id }}-student-{{ attendance.student_id }}-comment" value="{% if result %}{{ result.comment }}{% endif %}" placeholder="Комментарий" style="margin-top: 0.5rem;" />
                  </td>
                  {% endwith %}
                {% endwith %}
              {% empty %}
                <td>Добавьте упражнение, чтобы отмечать решения.</td>
              {% endfor %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{{ table_columns }}">Пока нет активных учеников на занятие.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p style="display: flex; justify-content: flex-end;">
      <button class="btn" type="submit">Сохранить таблицу</button>
    </p>
  </form>
{% endblock %}
