{% extends "crm/base.html" %}
{% block title %}{{ student.full_name }}{% endblock %}
{% block content %}
  <h1>{{ student.full_name }}</h1>
  <p><strong>Телефон для связи:</strong> {{ student.guardian_phone|default:"—" }}</p>
  <p>
    <strong>Родители в системе:</strong>
    {% if student.guardians.all %}
      {% for guardian in student.guardians.all %}
        {{ guardian.get_username }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    {% else %}
      —
    {% endif %}
  </p>
  {% if can_manage_guardians %}
    <p>
      <a class="btn btn-secondary" href="{% url 'crm:student_guardian_link' %}?student={{ student.pk }}&amp;next={{ request.get_full_path|urlencode }}">Привязать родителя</a>
    </p>
  {% endif %}
  <section class="sheet-card" style="margin-bottom: 2rem;">
    <h2>Баланс занятий</h2>
    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
      <div><strong>Куплено:</strong> {{ balance.purchased }}</div>
      <div><strong>Использовано:</strong> {{ balance.used }}</div>
      <div><strong>Остаток:</strong> {{ balance.remaining }}</div>
      <div><strong>Учтённых занятий:</strong> {{ balance.billable }}</div>
      <div>
        <strong>Долг:</strong>
        {% if balance.debt %}
          <span style="color: #d93025; font-weight: 600;">{{ balance.debt }}</span>
        {% else %}
          0
        {% endif %}
      </div>
    </div>
  </section>
  <section>
    <h2>Посещаемость</h2>
    <table class="sheet-table">

      <thead>
        <tr>
          <th>Дата</th>
          <th>Курс</th>
          <th>Статус</th>
          <th>Упражнения</th>

          <th>Комментарий</th>
        </tr>
      </thead>
      <tbody>
        {% for attendance in attendances %}
          <tr>
            <td>{{ attendance.lesson.date|date:"d.m.Y" }}</td>
            <td>{{ attendance.lesson.course.title }}</td>
            <td>{{ attendance.get_status_display }}</td>
            <td>
              {% with progress=attendance.exercise_progress %}
                {% if progress.total %}
                  <span class="chip chip--solved">{{ progress.solved }}/{{ progress.total }} решено</span>
                  {% if progress.partial %}<span class="chip chip--partial">{{ progress.partial }} частично</span>{% endif %}
                  {% if progress.pending %}<span class="chip chip--pending">{{ progress.pending }} не решено</span>{% endif %}
                {% else %}
                  <span class="chip">Без упражнений</span>
                {% endif %}
              {% endwith %}
            </td>

            <td>{{ attendance.comment|default:"—" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5">Данных о посещаемости пока нет.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  <section>
    <h2>Абонементы</h2>
    <table class="sheet-table">

      <thead>
        <tr>
          <th>Курс</th>
          <th>Занятий</th>
          <th>Стоимость</th>
          <th>Дата покупки</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody>
        {% for subscription in subscriptions %}
          <tr>
            <td>{{ subscription.course.title }}</td>
            <td>{{ subscription.lessons_included }}</td>
            <td>{{ subscription.price }} ₽</td>
            <td>{{ subscription.purchase_date|date:"d.m.Y" }}</td>
            <td>{{ subscription.is_active|yesno:"Активен,Неактивен" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5">Абонементы ещё не оформлены.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
